<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MemoryRoom ‚Äì Host</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #0b1020;
        --muted: #98a7ff99;
        --accent: #7aa2ff;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
        background: radial-gradient(
          900px 600px at 10% 10%,
          #18214d 0%,
          #0b1020 60%
        );
        color: #fff;
      }
      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 28px;
      }
      h1 {
        font-size: 28px;
        margin: 0 0 8px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .logo {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        object-fit: cover;
        border: 1px solid rgba(255, 255, 255, 0.25);
      }
      .sub {
        color: var(--muted);
        margin: 0 0 24px;
      }
      .card {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.04),
          rgba(255, 255, 255, 0.02)
        );
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 18px;
        padding: 18px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      input,
      select {
        width: 100%;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: #0f1530;
        color: #fff;
      }
      input[type="number"],
      input[type="color"] {
        max-width: 120px;
      }
      button {
        cursor: pointer;
        border: 0;
        background: var(--accent);
        color: #081126;
        padding: 12px 16px;
        border-radius: 12px;
        font-weight: 700;
      }
      button.ghost {
        background: transparent;
        color: #cfe0ff;
        border: 1px solid rgba(255, 255, 255, 0.18);
      }
      .muted {
        color: var(--muted);
      }
      .pill {
        background: #0e1533;
        border: 1px solid rgba(255, 255, 255, 0.14);
        padding: 6px 10px;
        border-radius: 999px;
        color: #cfe0ff;
        font-weight: 600;
        display: inline-flex;
        gap: 8px;
        align-items: center;
      }
      .players {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 6px;
      }
      .player {
        background: #0e1737;
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 8px 10px;
        border-radius: 999px;
      }
      .hr {
        height: 1px;
        background: rgba(255, 255, 255, 0.08);
        margin: 14px 0;
      }
      .list {
        display: grid;
        gap: 10px;
      }
      .q {
        background: #0f1738;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        padding: 12px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>
        <img class="logo" id="logo" src="" alt="logo" /> MemoryRoom üé¥ ‚Äì Host
      </h1>
      <p class="sub">
        Trang d√†nh cho gi√°o vi√™n/host: t·∫°o ph√≤ng, n·∫°p c·∫∑p Q/A, b·∫Øt ƒë·∫ßu v√°n, theo
        d√µi ng∆∞·ªùi ch∆°i & b·∫£ng ƒëi·ªÉm.
      </p>

      <div class="card">
        <div class="row" style="justify-content: space-between">
          <strong>B·∫£ng ƒëi·ªÅu khi·ªÉn</strong>
          <span class="pill"
            >Tr·∫°ng th√°i: <span id="status">Ch∆∞a v√†o ph√≤ng</span></span
          >
        </div>
        <div class="row" style="gap: 8px; margin-top: 8px">
          <span class="pill">V√°n: <span id="roundBadge">-</span></span>
          <span class="pill">‚è± <span id="elapsedHost">00:00</span></span>
        </div>

        <div class="hr"></div>

        <div class="row">
          <input id="roomId" placeholder="M√£ ph√≤ng (v√≠ d·ª•: ECO101)" />
          <button id="enterRoom">V√†o ph√≤ng</button>
          <button class="ghost" id="copyLink">
            Copy link d√†nh cho ng∆∞·ªùi ch∆°i
          </button>
        </div>
        <div class="row">
          <input id="logoInput" placeholder="D√°n URL logo l·ªõp (PNG/JPG)" />
          <label class="muted">M√†u ch·ªß ƒë·∫°o:</label>
          <input id="colorInput" type="color" value="#7aa2ff" />
          <button class="ghost" id="applyBrand">√Åp d·ª•ng</button>
        </div>

        <div class="hr"></div>
        <div class="row">
          <input type="file" id="fileInput" accept=".csv,.json" />
          <button id="loadPairs" class="ghost">T·∫£i c·∫∑p Q/A</button>
          <label>ƒêi·ªÉm m·ªói c·∫∑p:</label
          ><input id="memPts" type="number" value="5" /> <label>C·ªôt:</label
          ><input id="memCols" type="number" value="4" min="2" max="8" />
          <label>Th·ªùi l∆∞·ª£ng (gi√¢y):</label
          ><input id="limitSec" type="number" value="120" min="10" step="5" />
          <button id="startRound">B·∫Øt ƒë·∫ßu v√°n</button>
          <button class="ghost" id="nextRound">V√°n m·ªõi (gi·ªØ ƒëi·ªÉm)</button>
          <button class="ghost" id="resetRound">Xo√° b√†n / t·∫°o l·∫°i</button>
        </div>

        <div id="queue" class="list"></div>

        <div class="hr"></div>
        <div>
          <div class="row">
            <strong>Ng∆∞·ªùi ch∆°i</strong>
            <span class="pill" id="playerCount">0</span>
            <button class="ghost" id="exportCsv">Xu·∫•t ƒëi·ªÉm CSV</button>
          </div>
          <div class="players" id="players"></div>
        </div>

        <div class="hr"></div>
        <div>
          <div class="row"><strong>B·∫£ng ƒëi·ªÉm</strong></div>
          <div id="scoreboard" class="list"></div>
        </div>
      </div>

      <p class="muted" style="margin-top: 14px">
        CSV m·∫´u: <code>question,answer</code> m·ªói d√≤ng l√† m·ªôt c·∫∑p. JSON:
        <code>[{q,a},...]</code> ho·∫∑c <code>{pairs:[...]}</code>.
      </p>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        onValue,
        update,
        get,
        remove,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

      // === CONFIG FIREBASE ===
      const firebaseConfig = {
        apiKey: "AIzaSyDA3fp5A2cGB63kMA8TlEJ2x49rr4DiYbA",
        authDomain: "game-75e2a.firebaseapp.com",
        databaseURL:
          "https://game-75e2a-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "game-75e2a",
        storageBucket: "game-75e2a.firebasestorage.app",
        messagingSenderId: "763894782961",
        appId: "1:763894782961:web:84465068beb77de8024250",
        measurementId: "G-E10MQ37X5Y",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      const $ = (id) => document.getElementById(id);
      let roomIdGlobal = null,
        metaTimerHost = null,
        currentMeta = null,
        loadedPairs = [];

      // ===== V√†o ph√≤ng =====
      $("enterRoom").onclick = async () => {
        const room = $("roomId").value.trim().toUpperCase();
        if (!room) return alert("Nh·∫≠p m√£ ph√≤ng");
        roomIdGlobal = room;
        await update(ref(db, `rooms/${room}`), { createdAt: Date.now() });
        $("status").textContent = `ƒê√£ v√†o ph√≤ng ${room}`;
        bindPlayers(room);
        bindScores(room);
        $("copyLink").onclick = async () => {
          const url = `${location.origin}${location.pathname.replace(
            "host",
            "player"
          )}?room=${room}`;
          await navigator.clipboard.writeText(url);
          alert("ƒê√£ sao ch√©p link ng∆∞·ªùi ch∆°i: " + url);
        };
        // hi·ªÉn th·ªã v√°n + countdown
        onValue(ref(db, `rooms/${room}/memory/meta`), (snap) => {
          currentMeta = snap.val() || {};
          $("roundBadge").textContent = currentMeta.round || "-";
          if (metaTimerHost) clearInterval(metaTimerHost);
          metaTimerHost = setInterval(async () => {
            const start = currentMeta.startAt,
              endAt = currentMeta.endAt;
            if (!start || !endAt) {
              $("elapsedHost").textContent = "00:00";
              return;
            }
            let remain = Math.max(0, endAt - Date.now());
            const m = Math.floor(remain / 60000),
              s = Math.floor((remain % 60000) / 1000);
            $("elapsedHost").textContent = `${String(m).padStart(
              2,
              "0"
            )}:${String(s).padStart(2, "0")}`;
            // h·∫øt gi·ªù -> t·ª± k·∫øt th√∫c v√† kh√≥a
            if (remain <= 0 && !currentMeta.ended) {
              await update(ref(db, `rooms/${room}/memory/meta`), {
                ended: true,
                endAt: endAt,
              });
              await update(ref(db, `rooms/${room}/memory/state`), {
                lock: true,
              });
            }
          }, 500);
        });
      };

      // ===== Branding =====
      $("applyBrand").onclick = () => {
        const url = $("logoInput").value.trim();
        if (url) $("logo").src = url;
        const col = $("colorInput").value;
        if (col) document.documentElement.style.setProperty("--accent", col);
      };

      // ===== Players & Scores realtime =====
      function bindPlayers(room) {
        onValue(ref(db, `rooms/${room}/players`), (snap) => {
          const players = snap.val() || {};
          const ids = Object.keys(players);
          $("playerCount").textContent = ids.length;
          $("players").innerHTML = "";
          ids.forEach((id) => {
            const p = players[id];
            const chip = document.createElement("div");
            chip.className = "player";
            chip.textContent = `${p.name} ‚Ä¢ ${p.score || 0}`;
            $("players").appendChild(chip);
          });
        });
      }
      function bindScores(room) {
        onValue(ref(db, `rooms/${room}/scores`), (snap) => {
          const scores = snap.val() || {};
          const arr = Object.values(scores).sort(
            (a, b) => (b.score || 0) - (a.score || 0)
          );
          $("scoreboard").innerHTML = "";
          arr.forEach((s, i) => {
            const div = document.createElement("div");
            div.className = "q";
            div.innerHTML = `<div class='row' style='justify-content:space-between'><div><strong>${
              i + 1
            }. ${s.name}</strong></div><div>${s.score || 0} ƒëi·ªÉm</div></div>`;
            $("scoreboard").appendChild(div);
          });
        });
      }

      // ===== N·∫°p c·∫∑p =====
      $("loadPairs").onclick = () => $("fileInput").click();
      $("fileInput").onchange = async (e) => {
        const f = e.target.files[0];
        if (!f) return;
        const text = await f.text();
        loadedPairs = [];
        if (f.name.endsWith(".json")) {
          const j = JSON.parse(text);
          loadedPairs = Array.isArray(j) ? j : j.pairs || [];
        } else {
          const lines = text.split(/\r?\n/).filter(Boolean);
          const start = lines[0].toLowerCase().includes("question") ? 1 : 0;
          for (let i = start; i < lines.length; i++) {
            const [q, a] = lines[i].split(",");
            if (q && a) loadedPairs.push({ q, a });
          }
        }
        $("queue").innerHTML = loadedPairs.length
          ? `<div class='q'>ƒê√£ n·∫°p <strong>${loadedPairs.length}</strong> c·∫∑p. B·∫•m "B·∫Øt ƒë·∫ßu v√°n" ƒë·ªÉ t·∫°o b√†n.</div>`
          : `<div class='muted'>(Ch∆∞a c√≥ c·∫∑p)</div>`;
      };

      // ===== B·∫Øt ƒë·∫ßu/Next v√°n =====
      $("startRound").onclick = async () => {
        await createRound(false);
      };
      $("nextRound").onclick = async () => {
        await createRound(true);
      };

      async function createRound(incrementRound) {
        const room = roomIdGlobal || $("roomId").value.trim().toUpperCase();
        if (!room) return alert("Nh·∫≠p m√£ ph√≤ng");
        if (!loadedPairs.length) return alert("H√£y t·∫£i CSV/JSON c·∫∑p Q/A");

        const cols = Math.max(2, Math.min(8, Number($("memCols").value || 4)));
        const pts = Number($("memPts").value || 5);
        const limitSec = Math.max(5, Number($("limitSec").value || 120));
        const now = Date.now();
        const endAt = now + limitSec * 1000;

        // deck
        const deck = [];
        let cid = 0;
        loadedPairs.forEach((p, idx) => {
          deck.push({ id: cid++, pair: idx, text: p.q });
          deck.push({ id: cid++, pair: idx, text: p.a });
        });
        for (let i = deck.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [deck[i], deck[j]] = [deck[j], deck[i]];
        }

        const state = {
          cols,
          pts,
          deck: deck.map((c) => ({
            id: c.id,
            pair: c.pair,
            text: c.text,
            removed: false,
          })),
          flipped: [],
          lock: false,
        };
        const metaRef = ref(db, `rooms/${room}/memory/meta`);
        const prev = (await get(metaRef)).val() || {};
        const round = incrementRound
          ? Number(prev.round || 0) + 1
          : Number(prev.round || 0) || 1;

        await update(ref(db, `rooms/${room}/memory/state`), state);
        await update(metaRef, {
          left: loadedPairs.length,
          round,
          limitSec,
          startAt: now,
          endAt,
          ended: false,
        });
        alert(`ƒê√£ t·∫°o b√†n ${deck.length} th·∫ª (V√°n ${round}, ${limitSec}s)`);
      }

      // ===== Xo√° b√†n =====
      $("resetRound").onclick = async () => {
        const room = roomIdGlobal || $("roomId").value.trim().toUpperCase();
        if (!room) return alert("Nh·∫≠p m√£ ph√≤ng");
        await remove(ref(db, `rooms/${room}/memory`));
        alert("ƒê√£ xo√° b√†n. B·∫°n c√≥ th·ªÉ b·∫Øt ƒë·∫ßu v√°n m·ªõi.");
      };

      // ===== Export ƒëi·ªÉm CSV =====
      $("exportCsv").onclick = async () => {
        const room = roomIdGlobal || $("roomId").value.trim().toUpperCase();
        if (!room) return alert("Nh·∫≠p m√£ ph√≤ng");
        const scores = (await get(ref(db, `rooms/${room}/scores`))).val() || {};
        const rows = [["name", "score"]];
        Object.values(scores).forEach((s) => rows.push([s.name, s.score || 0]));
        const csv = rows
          .map((r) =>
            r.map((x) => `"${String(x).replace(/"/g, '""')}"`).join(",")
          )
          .join("\n");
        const blob = new Blob(["\ufeff" + csv], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `scoreboard_${Date.now()}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      };
    </script>
  </body>
</html>
