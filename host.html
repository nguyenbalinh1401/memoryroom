<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MemoryRoom ‚Äì Host</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root{--bg:#0b1020;--muted:#98a7ff99;--accent:#7aa2ff}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:radial-gradient(900px 600px at 10% 10%,#18214d 0%,#0b1020 60%);color:#fff}
    .wrap{max-width:1100px;margin:0 auto;padding:28px}
    h1{font-size:28px;margin:0 0 8px;display:flex;align-items:center;gap:10px}
    .logo{width:36px;height:36px;border-radius:8px;object-fit:cover;border:1px solid rgba(255,255,255,.25)}
    .sub{color:var(--muted);margin:0 0 24px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    input,select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:#0f1530;color:#fff}
    input[type="number"],input[type="color"]{max-width:140px}
    button{cursor:pointer;border:0;background:var(--accent);color:#081126;padding:12px 16px;border-radius:12px;font-weight:700}
    button.ghost{background:transparent;color:#cfe0ff;border:1px solid rgba(255,255,255,.18)}
    .muted{color:var(--muted)}
    .pill{background:#0e1533;border:1px solid rgba(255,255,255,.14);padding:6px 10px;border-radius:999px;color:#cfe0ff;font-weight:600;display:inline-flex;gap:8px;align-items:center}
    .players{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .player{background:#0e1737;border:1px solid rgba(255,255,255,.1);padding:8px 10px;border-radius:999px}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
    .list{display:grid;gap:10px}
    .q{background:#0f1738;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>
      <img class="logo" id="logo"
           src="https://images.prismic.io/quizlet-web/ZuOC_7VsGrYSvUXJ_VI-VN7Match.png?auto=format,compress"
           alt="logo"/>
      MemoryRoom üé¥ ‚Äì Host
    </h1>
    <p class="sub">
      Host ph√°t <strong>m·ªôt CSV duy nh·∫•t</strong> l√†m b·ªô ƒë·ªÅ chung. Ng∆∞·ªùi ch∆°i v√†o c√πng room nh∆∞ng m·ªói ng∆∞·ªùi c√≥ <strong>session ri√™ng</strong> (b√†n ri√™ng), v√†
      <strong>ƒë·ªìng h·ªì t·ªïng</strong> c·ªßa phi√™n √°p d·ª•ng cho t·∫•t c·∫£.
    </p>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <strong>B·∫£ng ƒëi·ªÅu khi·ªÉn</strong>
        <span class="pill">Tr·∫°ng th√°i: <span id="status">Ch∆∞a v√†o ph√≤ng</span></span>
      </div>

      <div class="row" style="gap:8px;margin-top:8px">
        <span class="pill">V√≤ng t·ªëi ƒëa: <span id="roundMax">-</span></span>
        <span class="pill">‚è± C√≤n: <span id="countdown">--:--</span></span>
      </div>

      <div class="hr"></div>

      <div class="row">
        <input id="roomId" placeholder="M√£ ph√≤ng (v√≠ d·ª•: ECO101)"/>
        <button id="enterRoom">V√†o ph√≤ng</button>
        <button class="ghost" id="copyLink">Copy link ng∆∞·ªùi ch∆°i</button>
      </div>

      <div class="row">
        <input id="logoInput" placeholder="D√°n URL logo l·ªõp (PNG/JPG)"/>
        <label class="muted">M√†u ch·ªß ƒë·∫°o:</label>
        <input id="colorInput" type="color" value="#7aa2ff"/>
        <button class="ghost" id="applyBrand">√Åp d·ª•ng</button>
      </div>

      <div class="hr"></div>

      <div class="row">
        <input type="file" id="fileInput" accept=".csv,.json"/>
        <button id="loadPairs" class="ghost">T·∫£i c·∫∑p Q/A</button>
        <label>T·ªïng th·ªùi gian (gi√¢y)</label>
        <input id="sessionSec" type="number" value="300" min="30" step="10"/>
        <button id="startSession">B·∫Øt ƒë·∫ßu phi√™n</button>
        <button class="ghost" id="resetSession">K·∫øt th√∫c phi√™n</button>
      </div>

      <div id="queue" class="list"></div>

      <div class="hr"></div>
      <div>
        <div class="row">
          <strong>Ng∆∞·ªùi ch∆°i</strong>
          <span class="pill" id="playerCount">0</span>
          <button class="ghost" id="exportCsv">Xu·∫•t ƒëi·ªÉm CSV</button>
        </div>
        <div class="players" id="players"></div>
      </div>

      <div class="hr"></div>
      <div>
        <div class="row"><strong>Ti·∫øn ƒë·ªô theo ng∆∞·ªùi ch∆°i</strong></div>
        <div id="progress" class="list"></div>
      </div>

      <div class="hr"></div>
      <div>
        <div class="row"><strong>B·∫£ng ƒëi·ªÉm</strong></div>
        <div id="scoreboard" class="list"></div>
      </div>
    </div>

    <p class="muted" style="margin-top:14px">
      CSV m·∫´u: <code>question,answer</code> m·ªói d√≤ng l√† m·ªôt c·∫∑p. JSON: <code>[{q,a},...]</code> ho·∫∑c <code>{pairs:[...]}</code>.
    </p>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getDatabase, ref, set, onValue, update, get } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

    // === FIREBASE CONFIG ===
    const firebaseConfig = {
      apiKey:"AIzaSyDA3fp5A2cGB63kMA8TlEJ2x49rr4DiYbA",
      authDomain:"game-75e2a.firebaseapp.com",
      databaseURL:"https://game-75e2a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId:"game-75e2a",
      storageBucket:"game-75e2a.firebasestorage.app",
      messagingSenderId:"763894782961",
      appId:"1:763894782961:web:84465068beb77de8024250",
      measurementId:"G-E10MQ37X5Y"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const $ = (id)=>document.getElementById(id);
    let roomIdGlobal=null, tickTimer=null, loadedPairs=[];

    // ====== V√†o ph√≤ng ======
    $("enterRoom").onclick = async ()=>{
      const room = $("roomId").value.trim().toUpperCase();
      if(!room) return alert('Nh·∫≠p m√£ ph√≤ng');
      roomIdGlobal = room;
      await update(ref(db,`rooms/${room}`),{createdAt:Date.now()});
      $("status").textContent = `ƒê√£ v√†o ph√≤ng ${room}`;
      bindPlayers(room);
      bindScores(room);
      bindSession(room);
      bindProgress(room);
      $("copyLink").onclick = async ()=>{
        const url = `${location.origin}${location.pathname.replace('host','player')}?room=${room}`;
        await navigator.clipboard.writeText(url);
        alert('ƒê√£ sao ch√©p link ng∆∞·ªùi ch∆°i: '+url);
      };
    };

    // ====== Branding ======
    $("applyBrand").onclick = ()=>{
      const url=$("logoInput").value.trim();
      if(url) $("logo").src = url;
      const col=$("colorInput").value;
      if(col) document.documentElement.style.setProperty('--accent', col);
    };

    // ====== Players & Scores ======
    function bindPlayers(room){
      onValue(ref(db,`rooms/${room}/players`),(snap)=>{
        const players=snap.val()||{};
        const ids=Object.keys(players);
        $("playerCount").textContent=ids.length;
        $("players").innerHTML='';
        ids.forEach(id=>{
          const p=players[id];
          const chip=document.createElement('div');
          chip.className='player';
          chip.textContent=`${p.name} ‚Ä¢ ${p.score||0}`;
          $("players").appendChild(chip);
        });
      });
    }

    function bindScores(room){
      onValue(ref(db,`rooms/${room}/scores`),(snap)=>{
        const scores=snap.val()||{};
        const arr=Object.values(scores).sort((a,b)=>(b.score||0)-(a.score||0));
        $("scoreboard").innerHTML='';
        arr.forEach((s,i)=>{
          const div=document.createElement('div');
          div.className='q';
          div.innerHTML=`<div class='row' style='justify-content:space-between'>
            <div><strong>${i+1}. ${s.name}</strong></div>
            <div>${s.score||0} ƒëi·ªÉm</div>
          </div>`;
          $("scoreboard").appendChild(div);
        });
      });
    }

    // ====== Ti·∫øn ƒë·ªô t·ª´ng ng∆∞·ªùi (round/left c√° nh√¢n) ======
    function bindProgress(room){
      onValue(ref(db, `rooms/${room}/sessions`), async (snap)=>{
        const data = snap.val() || {};
        const scores = (await get(ref(db,`rooms/${room}/scores`))).val() || {};
        const players = (await get(ref(db,`rooms/${room}/players`))).val() || {};
        $("progress").innerHTML = "";
        Object.keys(data).forEach(pid=>{
          const meta = data[pid]?.meta || {};
          const name = players[pid]?.name || pid;
          const score = scores[pid]?.score || 0;
          const div = document.createElement("div");
          div.className="q";
          div.innerHTML = `
            <div class="row" style="justify-content:space-between">
              <div><strong>${name}</strong></div>
              <div>V√≤ng: <b>${meta.round ?? '-'}</b></div>
              <div>C√≤n c·∫∑p: <b>${Number.isFinite(meta.left)? meta.left : '--'}</b></div>
              <div>ƒêi·ªÉm: <b>${score}</b></div>
            </div>`;
          $("progress").appendChild(div);
        });
      });
    }

    // ====== N·∫°p c·∫∑p (CSV/JSON) ======
    $("loadPairs").onclick = ()=> $("fileInput").click();

    // t√°ch CSV chu·∫©n (kh√¥ng t√°ch trong d·∫•u nh√°y)
    function smartSplitCSV(line){
      const out=[]; let cur='', inQuotes=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch==='\"'){
          if(inQuotes && line[i+1]==='\"'){ cur+='\"'; i++; } // escape ""
          else inQuotes=!inQuotes;
        } else if(ch===',' && !inQuotes){
          out.push(cur); cur='';
        } else cur+=ch;
      }
      out.push(cur);
      return out;
    }

    $("fileInput").onchange = async (e)=>{
      const f=e.target.files[0]; if(!f) return;
      const text=await f.text();
      loadedPairs=[];
      if(f.name.endsWith('.json')){
        const j=JSON.parse(text);
        loadedPairs = Array.isArray(j)? j : (j.pairs||[]);
      } else {
        const lines=text.split(/\r?\n/).filter(Boolean);
        const first = lines[0].toLowerCase();
        const start = (first.includes('question') && first.includes('answer')) ? 1 : 0;
        for(let i=start;i<lines.length;i++){
          const cols = smartSplitCSV(lines[i]).map(s=>s.replace(/^"(.*)"$/,'$1'));
          const q = cols[0], a = cols[1];
          if(q && a) loadedPairs.push({q,a});
        }
      }
      $("queue").innerHTML = loadedPairs.length
        ? `<div class='q'>ƒê√£ n·∫°p <strong>${loadedPairs.length}</strong> c·∫∑p. B·∫•m "B·∫Øt ƒë·∫ßu phi√™n".</div>`
        : `<div class='muted'>(Ch∆∞a c√≥ c·∫∑p)</div>`;
    };

    // ====== Phi√™n ch∆°i (ƒë·ªìng h·ªì t·ªïng) ======
    $("startSession").onclick = async ()=>{
      try{
        const room = roomIdGlobal || $("roomId").value.trim().toUpperCase();
        if(!room) return alert('Nh·∫≠p m√£ ph√≤ng');
        if(!loadedPairs.length) return alert('H√£y t·∫£i CSV/JSON c·∫∑p Q/A');

        const MAX_PER_ROUND = 7;
        const totalSec = Math.max(30, Number($("sessionSec").value||300));

        // T√≠nh s·ªë v√≤ng 6‚Äì7 c√¢u
        const n=loadedPairs.length;
        const roundsMax = Math.ceil(n / MAX_PER_ROUND);
        const baseSize  = Math.floor(n / roundsMax); // th∆∞·ªùng = 6
        const extra     = n % roundsMax;             // s·ªë v√≤ng ƒë·∫ßu c√≥ 7 c√¢u

        // Th·ª© t·ª± ng·∫´u nhi√™n ƒë·ªÉ chia v√≤ng
        const order=[...Array(n).keys()];
        for(let i=order.length-1;i>0;i--){
          const j=Math.floor(Math.random()*(i+1));
          [order[i],order[j]]=[order[j],order[i]];
        }

        const now=Date.now(); const endAt = now + totalSec*1000;

        // Ph√°t ƒë·ªÅ + order chung cho room
        await set(ref(db,`rooms/${room}/memory/pairs`), loadedPairs);
        await set(ref(db,`rooms/${room}/memory/order`), order);

        // Ch·ªâ set meta phi√™n (kh√¥ng t·∫°o state c·∫•p room)
        await update(ref(db,`rooms/${room}/memory/meta`), {
          session:{ totalSec, startAt: now, endAt, roundsMax, baseSize, extra },
          ended:false
        });

        alert(`ƒê√£ b·∫Øt ƒë·∫ßu phi√™n ${totalSec}s ‚Äì ${n} c·∫∑p ‚Üí ${roundsMax} v√≤ng (m·ªói v√≤ng 6‚Äì7 c√¢u).`);
      }catch(e){
        console.error('startSession error', e);
        alert('Kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu phi√™n: '+(e?.message||e));
      }
    };

    $("resetSession").onclick = async ()=>{
      const room = roomIdGlobal || $("roomId").value.trim().toUpperCase();
      if(!room) return alert('Nh·∫≠p m√£ ph√≤ng');
      await update(ref(db,`rooms/${room}/memory/meta`),{ended:true});
      alert('ƒê√£ k·∫øt th√∫c phi√™n.');
    };

    // ====== ƒê·∫øm ng∆∞·ª£c (room-level) ======
    function bindSession(room){
      onValue(ref(db,`rooms/${room}/memory/meta/session`),(snap)=>{
        const s = snap.val() || null;
        $("roundMax").textContent = s?.roundsMax ?? '-';
        if(tickTimer) clearInterval(tickTimer);
        if(!s?.endAt){ $("countdown").textContent='--:--'; return; }
        tickTimer = setInterval(()=>{
          const remain = Math.max(0,(s.endAt||0) - Date.now());
          const m = Math.floor(remain/60000), ss = Math.floor((remain%60000)/1000);
          $("countdown").textContent = `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
        },500);
      });
    }

    // ====== Xu·∫•t ƒëi·ªÉm CSV ======
    $("exportCsv").onclick = async ()=>{
      const room = roomIdGlobal || $("roomId").value.trim().toUpperCase();
      if(!room) return alert('Nh·∫≠p m√£ ph√≤ng');
      const scores=(await get(ref(db,`rooms/${room}/scores`))).val()||{};
      const rows=[["name","score"]];
      Object.values(scores).forEach(s=> rows.push([s.name, s.score||0]));
      const csv = rows.map(r=> r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`scoreboard_${Date.now()}.csv`; a.click();
      URL.revokeObjectURL(url);
    };
  </script>
</body>
</html>
