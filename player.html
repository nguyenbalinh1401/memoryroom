<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MemoryRoom ‚Äì Player</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0b1020; --muted:#98a7ff99; --accent:#7aa2ff; }
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:radial-gradient(900px 600px at 10% 10%, #18214d 0%, #0b1020 60%);color:#fff}
    .wrap{max-width:900px;margin:0 auto;padding:28px}
    h1{font-size:28px;margin:0 0 8px;display:flex;align-items:center;gap:10px}
    .logo{width:36px;height:36px;border-radius:8px;object-fit:cover;border:1px solid rgba(255,255,255,.25)}
    .sub{color:var(--muted);margin:0 0 24px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:#0f1530;color:#fff}
    button{cursor:pointer;border:0;background:var(--accent);color:#081126;padding:12px 16px;border-radius:12px;font-weight:700}
    button.ghost{background:transparent;color:#cfe0ff;border:1px solid rgba(255,255,255,.18)}
    .muted{color:var(--muted)} .pill{background:#0e1533;border:1px solid rgba(255,255,255,.14);padding:6px 10px;border-radius:999px;color:#cfe0ff;font-weight:600;display:inline-flex;gap:8px;align-items:center}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
    .ans{background:#0c1330;border:1px solid rgba(255,255,255,.12);padding:14px;border-radius:14px;min-height:120px;font-size:18px;line-height:1.3;color:#eaf0ff;white-space:normal;word-break:break-word;display:flex;align-items:center;justify-content:center}
    @media(max-width:640px){.ans{min-height:90px;font-size:16px}}
    .ans.hidden{color:#ff7a7a;font-weight:800}
    .ans.revealed{background:#0f1a44;border-color:#6ea8ff;box-shadow:0 0 0 2px rgba(110,168,255,.18) inset}
  </style>
</head>
<body>
  <div class="wrap">
    <h1><img class="logo" id="logo" src="" alt="logo"/> MemoryRoom üé¥ ‚Äì Player</h1>
    <p class="sub">Trang d√†nh cho ng∆∞·ªùi ch∆°i. Nh·∫≠p m√£ ph√≤ng & t√™n ‚Üí l·∫≠t th·∫ª theo th·ªùi gian th·ª±c.</p>

    <div class="card">
      <div class="row">
        <input id="joinRoom" placeholder="M√£ ph√≤ng"/>
        <input id="nickname" placeholder="T√™n c·ªßa b·∫°n"/>
        <button id="joinBtn">Tham gia</button>
      </div>
      <div class="hr"></div>
      <div id="playerArea" style="display:none">
        <div class="row" style="justify-content:space-between">
          <span class="pill">Ph√≤ng: <span id="roomBadge">-</span></span>
          <span class="pill">B·∫°n: <span id="me">-</span></span>
          <span class="pill">C√≤n c·∫∑p: <span id="memLeft">--</span></span>
        </div>
        <div class="hr"></div>
        <div id="board" style="display:grid;gap:12px"></div>
        <div class="muted" id="hint">Ch·ªçn 2 th·∫ª ƒë·ªÉ l·∫≠t</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getDatabase, ref, set, onValue, update, get } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

    // === THAY B·∫∞NG CONFIG C·ª¶A B·∫†N (GI·ªêNG HOST) ===
    const firebaseConfig = {
  apiKey: "AIzaSyDA3fp5A2cGB63kMA8TlEJ2x49rr4DiYbA",
  authDomain: "game-75e2a.firebaseapp.com",
  databaseURL: "https://game-75e2a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "game-75e2a",
  storageBucket: "game-75e2a.firebasestorage.app",
  messagingSenderId: "763894782961",
  appId: "1:763894782961:web:84465068beb77de8024250",
  measurementId: "G-E10MQ37X5Y"
};

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const $ = (id)=>document.getElementById(id);
    function qp(name){ const u=new URL(location.href); return u.searchParams.get(name); }
    const roomFromUrl = qp('room'); if(roomFromUrl) $("joinRoom").value = roomFromUrl;

    let joinedRoomId=null, myId=null;

    $("joinBtn").onclick = async ()=>{
      const room=$("joinRoom").value.trim().toUpperCase(); const name=$("nickname").value.trim();
      if(!room||!name) return alert('Nh·∫≠p m√£ ph√≤ng & t√™n'); joinedRoomId=room; myId='p_'+Math.random().toString(36).slice(2,8);
      await update(ref(db, `rooms/${room}/players/${myId}`), {name, score:0, joinedAt: Date.now()});
      await update(ref(db, `rooms/${room}/scores/${myId}`), {name, score:0});
      $("playerArea").style.display='block'; $("roomBadge").textContent=room; $("me").textContent=name; bindBoard();
    };

    function bindBoard(){
      onValue(ref(db, `rooms/${joinedRoomId}/memory/state`), async (snap)=>{
        const st=snap.val(); const board=$("board"); if(!st){ board.innerHTML='<div class="muted">Ch·ªù host b·∫Øt ƒë·∫ßu v√°n‚Ä¶</div>'; return; }
        board.style.gridTemplateColumns = `repeat(${st.cols||4}, minmax(0,1fr))`;
        const meta=(await get(ref(db, `rooms/${joinedRoomId}/memory/meta`))).val()||{left:'--'}; $("memLeft").textContent=meta.left;
        board.innerHTML='';
        st.deck.forEach(card=>{
          const btn=document.createElement('button');
          const flipped=(st.flipped||[]).includes(card.id);
          btn.className='ans ' + ((flipped||card.removed)?'revealed':'hidden');
          btn.style.height='120px';
          btn.disabled=card.removed || st.lock;
          btn.textContent=(flipped||card.removed)? card.text : '‚ùì';
          if(card.removed) btn.style.visibility='hidden';
          btn.onclick = ()=> flipCard(card.id);
          board.appendChild(btn);
        });
        $("hint").textContent = st.lock? 'ƒêang ki·ªÉm tra c·∫∑p‚Ä¶' : 'Ch·ªçn 2 th·∫ª ƒë·ªÉ l·∫≠t';
      });
    }

    async function flipCard(cardId){
      const base = ref(db, `rooms/${joinedRoomId}/memory/state`);
      const st = (await get(base)).val(); if(!st || st.lock) return;
      const card = st.deck.find(c=>c.id===cardId); if(!card || card.removed) return;
      if((st.flipped||[]).includes(cardId)) return;
      const flipped=[...(st.flipped||[]), cardId]; await update(base,{flipped});
      if(flipped.length===2){
        await update(base,{lock:true});
        const [c1,c2]=flipped.map(id=> st.deck.find(c=>c.id===id));
        const match = c1.pair===c2.pair && c1.id!==c2.id;
        if(match){
          st.deck = st.deck.map(c=> (c.id===c1.id||c.id===c2.id)? {...c,removed:true}:c);
          await update(base,{deck:st.deck, flipped:[], lock:false});
          const metaRef=ref(db, `rooms/${joinedRoomId}/memory/meta`);
          const m=(await get(metaRef)).val()||{left:0}; await update(metaRef,{left: Math.max(0,(m.left||0)-1)});
          const sRef=ref(db, `rooms/${joinedRoomId}/scores/${myId}`); const p=(await get(sRef)).val()||{name:'',score:0};
          const pts=(st.pts||5); await update(sRef,{name:(p.name||$("me").textContent), score:(p.score||0)+pts});
          await update(ref(db, `rooms/${joinedRoomId}/players/${myId}`), {score:(p.score||0)+pts});
        }else{
          setTimeout(async()=>{ await update(base,{flipped:[], lock:false}); }, 900);
        }
      }
    }
  </script>
</body>
</html>
